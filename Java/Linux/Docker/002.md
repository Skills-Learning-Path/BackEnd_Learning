# Docker使用

## Docker常用命令

### 帮助命令

```bash
docker version    #显示docker版本
docker info       # 显示docker的系统信息，包括镜像和容器的数量
docker 命令 --help #帮助命令
```

>   https://docs.docker.com/reference/

### 镜像命令

-   docker images 查看所有本地主机上的镜像

```bash
[root@CentOS122 ubuntu]# docker images
REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE
hello-world         latest              bf756fb1ae65        6 months ago        13.3kB
 
#解释
REPOSITORY          镜像的仓库源
TAG                 镜像的标签
IMAGE ID            镜像id
CREATED             镜像的创建时间
13.3kB              镜像的大小
 
#可选项
-a, --all            #列出所有镜像
-q, --quiet          #只显示镜像的id
```

-   docker search 搜索镜像

```bash
 ~$ docker search mysql
NAME                              DESCRIPTION                                     STARS               OFFICIAL            AUTOMATED
mysql                             MySQL is a widely used, open-source relation…   9931                [OK]                
mariadb                           MariaDB is a community-developed fork of MyS…   3634                [OK]                
mysql/mysql-server                Optimized MySQL Server Docker images. Create…   723                                     [OK]
percona                           Percona Server is a fork of the MySQL relati…   508                 [OK]                
centos/mysql-57-centos7           MySQL 5.7 SQL database server                   83                                      
mysql/mysql-cluster               Experimental MySQL Cluster Docker images. Cr…   75                                      
centurylink/mysql                 Image containing mysql. Optimized to be link…   61                                      [OK]
bitnami/mysql                     Bitnami MySQL Docker Image                      44                                      [OK]
deitch/mysql-backup               REPLACED! Please use http://hub.docker.com/r…   41                                      [OK]
tutum/mysql                       Base docker image to run a MySQL database se…   35                                      
prom/mysqld-exporter                                                              31                                      [OK]
schickling/mysql-backup-s3        Backup MySQL to S3 (supports periodic backup…   30                                      [OK]
databack/mysql-backup             Back up mysql databases to... anywhere!         30                                      
linuxserver/mysql                 A Mysql container, brought to you by LinuxSe…   25                                      
centos/mysql-56-centos7           MySQL 5.6 SQL database server                   20                                      
circleci/mysql                    MySQL is a widely used, open-source relation…   19                                      
mysql/mysql-router                MySQL Router provides transparent routing be…   16                                      
arey/mysql-client                 Run a MySQL client from a docker container      14                                      [OK]
fradelg/mysql-cron-backup         MySQL/MariaDB database backup using cron tas…   8                                       [OK]
openshift/mysql-55-centos7        DEPRECATED: A Centos7 based MySQL v5.5 image…   6                                       
devilbox/mysql                    Retagged MySQL, MariaDB and PerconaDB offici…   3                                       
ansibleplaybookbundle/mysql-apb   An APB which deploys RHSCL MySQL                2                                       [OK]
jelastic/mysql                    An image of the MySQL database server mainta…   1                                       
widdpim/mysql-client              Dockerized MySQL Client (5.7) including Curl…   1                                       [OK]
monasca/mysql-init                A minimal decoupled init container for mysql    0                                       

#解释
Options:
  -f, --filter filter   Filter output based on conditions provided
      --format string   Pretty-print search using a Go template
      --limit int       Max number of search results (default 25)
      --no-trunc        Don't truncate output

 ~$ sudo docker search -f=STARS=3000 mysql
NAME                DESCRIPTION                                     STARS               OFFICIAL            AUTOMATED
mysql               MySQL is a widely used, open-source relation…   9931                [OK]                
mariadb             MariaDB is a community-developed fork of MyS…   3634                [OK]                
```

-   docker pull 下载镜像

```bash
# 下载镜像 docker pull 镜像名[:tag]
[root@CentOS122 ubuntu]# docker pull tomcat:8
8: Pulling from library/tomcat #如果不写tag，默认就是latest
90fe46dd8199: Already exists   #分层下载： docker image 的核心 联合文件系统
35a4f1977689: Already exists 
bbc37f14aded: Already exists 
74e27dc593d4: Already exists 
93a01fbfad7f: Already exists 
1478df405869: Pull complete 
64f0dd11682b: Pull complete 
68ff4e050d11: Pull complete 
f576086003cf: Pull complete 
3b72593ce10e: Pull complete 
Digest: sha256:0c6234e7ec9d10ab32c06423ab829b32e3183ba5bf2620ee66de866df640a027  # 签名 防伪
Status: Downloaded newer image for tomcat:8
docker.io/library/tomcat:8 #真实地址
 
#等价于
docker pull tomcat:8
docker pull docker.io/library/tomcat:8
```

docker rmi 删除镜像

```bash
$ docker rmi -f bf756fb1ae65     #删除指定镜像
$ docker rmi -f 容器id 容器id ... #删除多个容器
$ docker rmi -f $(docker images -aq) #删除全部的容器
```

### 容器命令

有了镜像才可以创建容器

-   docker run 新建容器并启动

```bash
docker run [可选参数] image
 
#参数说明
--name="Nmae"    容器名字    tomcat01 toncat02. 用来区分容器
-d               后台方式运行
-it              使用交互式方式运行，进入容器查看内容
-p               指定容器的端口  -p 8080:8080
 1.   -p ip：主机端口：容器端口
 2.   -p 主机端口：容器端口（常用）
 3.   -p 容器端口
 4.    容器端口
-p               随机指定端口
```

测试：启动并进入容器

```bash
 ~$ sudo docker run -it centos /bin/bash
 [root@67de465e7b95 /]# ls
bin  dev  etc  home  lib  lib64  lost+found  media  mnt  opt  proc  root  run  sbin  srv  sys  tmp  usr  var
[root@67de465e7b95 /]# exit #退出容器
exit
```

-   docker ps 显示出所有运行的容器

```bash
#docker ps [可选参数] 
                #显示当前正在运行的容器
-a              #列出当前正在运行的容器+带出历史运行过的容器
-n=?            #显示最近创建的容器
-q              #只显示容器编号
    
 
$ docker ps
CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES
$ docker ps -a
CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS                            PORTS                               NAMES
fe6cd8ee0d7b        centos              "/bin/bash"              3 minutes ago       Exited (130) About a minute ago                                       lucid_banach
5423b2d7463d        bf756fb1ae65        "/hello"                 50 minutes ago      Exited (0) 50 minutes ago                                             funny_keller
d4e3e35788fe        bf756fb1ae65        "/hello"                 23 hours ago        Exited (0) 23 hours ago                                               trusting_leavitt
c83ed1050c4a        mysql               "docker-entrypoint.s…"   9 days ago          Exited (255) 24 hours ago         0.0.0.0:3306->3306/tcp, 33060/tcp   mymysql
850e796a3e12        bf756fb1ae65        "/hello"                 10 days ago         Exited (0) 10 days ago                                                relaxed_nobel
 ~$ docker ps -n=1
CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS                     PORTS               NAMES
fe6cd8ee0d7b        centos              "/bin/bash"              3 minutes ago       Exited (130) About a minute ago                                       lucid_banach
```

-   exit 退出容器

```bash
eixt #直接容器停止并退出
ctrl+p+q  #容器不停止退出
```

-   docker rm 删除容器

```bash
docker rm 容器id            #删除指定的容器，不能删除正在运行的容器；
docker rm -f 容器id         #强制删除正在运行的容器
docker rm -f $(docker ps -aq)      #删除所有容器
docker ps -a -q | xargs docker rm  #删除所有的容器
```

-   docker start 启动和停止容器的操作

```bash
docker start 容器id            #启动容器
docker restart 容器id          #重启容器
docker stop 容器id             #停止当前正在运行的容器
docker kill 容器id             #强制停止当前容器
```

### 其它命令

-   docker run -d 后台启动容器

```bash
#命令 docker run -d 命令
$ docker run -d centos
 
#问题docker ps 发现centos停止了
 
#常见的坑：docker容器使用后台启动，就必须要有一个前台的进程，docker发现没有应用，就会自动停止。
#nginx，容器启动后，发现自己没有提供服务，就会立刻停止，就是没有程序了
```

-   docker logs 查看日志

```bash
 #自己写一段脚本
$ docker run -d centos /bin/sh -c "while true;do echo abc;sleep 1;done"
#显示日志
-tf         #显示全部日志
--tail number #要显示的日志参数
$ docker logs -f --tail=200 60d2e46767cc
```

-   docker top 查看容器内部进程信息

```bash
$ docker top 5467d2706b3f
UID                 PID                 PPID                C                   STIME               TTY                 TIME                CMD
root                10484               10469               0                   06:35               ?                   00:00:00            /bin/sh -c while true;do echo shijun;sleep 1;done
root                10735               10484               0                   06:37               ?                   00:00:00            /usr/bin/coreutils --coreutils-pro
```

docker inspect 查看容器元数据

```bash
$ docker inspect 5467d2706b3f
[
    {
        "Id": "5467d2706b3f641d1101ca76332eea6b20a00ca5c5e37f033066c05e378be48a",
        "Created": "2020-07-09T22:35:13.490987912Z",
        "Path": "/bin/sh",
        "Args": [
            "-c",
            "while true;do echo abc;sleep 1;done"
        ],
        "State": {
            "Status": "running",
            "Running": true,
            "Paused": false,
            "Restarting": false,
            "OOMKilled": false,
            "Dead": false,
            "Pid": 10484,
            "ExitCode": 0,
            "Error": "",
            "StartedAt": "2020-07-09T22:35:15.253750561Z",
            "FinishedAt": "0001-01-01T00:00:00Z"
        },
        "Image": "sha256:831691599b88ad6cc2a4abbd0e89661a121aff14cfa289ad840fd3946f274f1f",
        "ResolvConfPath": "/var/lib/docker/containers/5467d2706b3f641d1101ca76332eea6b20a00ca5c5e37f033066c05e378be48a/resolv.conf",
        "HostnamePath": "/var/lib/docker/containers/5467d2706b3f641d1101ca76332eea6b20a00ca5c5e37f033066c05e378be48a/hostname",
        "HostsPath": "/var/lib/docker/containers/5467d2706b3f641d1101ca76332eea6b20a00ca5c5e37f033066c05e378be48a/hosts",
        "LogPath": "/var/lib/docker/containers/5467d2706b3f641d1101ca76332eea6b20a00ca5c5e37f033066c05e378be48a/5467d2706b3f641d1101ca76332eea6b20a00ca5c5e37f033066c05e378be48a-json.log",
        "Name": "/affectionate_heyrovsky",
        "RestartCount": 0,
        "Driver": "overlay2",
        "Platform": "linux",
        "MountLabel": "",
        "ProcessLabel": "",
        "AppArmorProfile": "",
        "ExecIDs": null,
        "HostConfig": {
            "Binds": null,
            "ContainerIDFile": "",
            "LogConfig": {
                "Type": "json-file",
                "Config": {}
            },
            "NetworkMode": "default",
            "PortBindings": {},
            "RestartPolicy": {
                "Name": "no",
                "MaximumRetryCount": 0
            },
            "AutoRemove": false,
            "VolumeDriver": "",
            "VolumesFrom": null,
            "CapAdd": null,
            "CapDrop": null,
            "Capabilities": null,
            "Dns": [],
            "DnsOptions": [],
            "DnsSearch": [],
            "ExtraHosts": null,
            "GroupAdd": null,
            "IpcMode": "private",
            "Cgroup": "",
            "Links": null,
            "OomScoreAdj": 0,
            "PidMode": "",
            "Privileged": false,
            "PublishAllPorts": false,
            "ReadonlyRootfs": false,
            "SecurityOpt": null,
            "UTSMode": "",
            "UsernsMode": "",
            "ShmSize": 67108864,
            "Runtime": "runc",
            "ConsoleSize": [
                0,
                0
            ],
            "Isolation": "",
            "CpuShares": 0,
            "Memory": 0,
            "NanoCpus": 0,
            "CgroupParent": "",
            "BlkioWeight": 0,
            "BlkioWeightDevice": [],
            "BlkioDeviceReadBps": null,
            "BlkioDeviceWriteBps": null,
            "BlkioDeviceReadIOps": null,
            "BlkioDeviceWriteIOps": null,
            "CpuPeriod": 0,
            "CpuQuota": 0,
            "CpuRealtimePeriod": 0,
            "CpuRealtimeRuntime": 0,
            "CpusetCpus": "",
            "CpusetMems": "",
            "Devices": [],
            "DeviceCgroupRules": null,
            "DeviceRequests": null,
            "KernelMemory": 0,
            "KernelMemoryTCP": 0,
            "MemoryReservation": 0,
            "MemorySwap": 0,
            "MemorySwappiness": null,
            "OomKillDisable": false,
            "PidsLimit": null,
            "Ulimits": null,
            "CpuCount": 0,
            "CpuPercent": 0,
            "IOMaximumIOps": 0,
            "IOMaximumBandwidth": 0,
            "MaskedPaths": [
                "/proc/asound",
                "/proc/acpi",
                "/proc/kcore",
                "/proc/keys",
                "/proc/latency_stats",
                "/proc/timer_list",
                "/proc/timer_stats",
                "/proc/sched_debug",
                "/proc/scsi",
                "/sys/firmware"
            ],
            "ReadonlyPaths": [
                "/proc/bus",
                "/proc/fs",
                "/proc/irq",
                "/proc/sys",
                "/proc/sysrq-trigger"
            ]
        },
        "GraphDriver": {
            "Data": {
                "LowerDir": "/var/lib/docker/overlay2/8a83580bdf045fa2c1bb55c34028f742a02b020f7714bd8a1378bfad4f48b03d-init/diff:/var/lib/docker/overlay2/b33aa1f4ccea184e655706729d226636fae2ae430e8b62029b77a394cf01d9e2/diff",
                "MergedDir": "/var/lib/docker/overlay2/8a83580bdf045fa2c1bb55c34028f742a02b020f7714bd8a1378bfad4f48b03d/merged",
                "UpperDir": "/var/lib/docker/overlay2/8a83580bdf045fa2c1bb55c34028f742a02b020f7714bd8a1378bfad4f48b03d/diff",
                "WorkDir": "/var/lib/docker/overlay2/8a83580bdf045fa2c1bb55c34028f742a02b020f7714bd8a1378bfad4f48b03d/work"
            },
            "Name": "overlay2"
        },
        "Mounts": [],
        "Config": {
            "Hostname": "5467d2706b3f",
            "Domainname": "",
            "User": "",
            "AttachStdin": false,
            "AttachStdout": false,
            "AttachStderr": false,
            "Tty": false,
            "OpenStdin": false,
            "StdinOnce": false,
            "Env": [
                "PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
            ],
            "Cmd": [
                "/bin/sh",
                "-c",
                "while true;do echo shijun;sleep 1;done"
            ],
            "Image": "centos",
            "Volumes": null,
            "WorkingDir": "",
            "Entrypoint": null,
            "OnBuild": null,
            "Labels": {
                "org.label-schema.build-date": "20200611",
                "org.label-schema.license": "GPLv2",
                "org.label-schema.name": "CentOS Base Image",
                "org.label-schema.schema-version": "1.0",
                "org.label-schema.vendor": "CentOS"
            }
        },
        "NetworkSettings": {
            "Bridge": "",
            "SandboxID": "7e451d65a35c125c30411e95c39d3f65b9fd2b0ca565b1a6ca861f45b1873497",
            "HairpinMode": false,
            "LinkLocalIPv6Address": "",
            "LinkLocalIPv6PrefixLen": 0,
            "Ports": {},
            "SandboxKey": "/var/run/docker/netns/7e451d65a35c",
            "SecondaryIPAddresses": null,
            "SecondaryIPv6Addresses": null,
            "EndpointID": "1fb7a41df08f0e29e5eb35060cd3bea3a9864a077ac55b4c913bfb03ab2170ba",
            "Gateway": "172.17.0.1",
            "GlobalIPv6Address": "",
            "GlobalIPv6PrefixLen": 0,
            "IPAddress": "172.17.0.3",
            "IPPrefixLen": 16,
            "IPv6Gateway": "",
            "MacAddress": "02:42:ac:11:00:03",
            "Networks": {
                "bridge": {
                    "IPAMConfig": null,
                    "Links": null,
                    "Aliases": null,
                    "NetworkID": "d7bfe3e3aca1d28ee0b0835b1541f344c93ce4de021d306eca5c1144bd068749",
                    "EndpointID": "1fb7a41df08f0e29e5eb35060cd3bea3a9864a077ac55b4c913bfb03ab2170ba",
                    "Gateway": "172.17.0.1",
                    "IPAddress": "172.17.0.3",
                    "IPPrefixLen": 16,
                    "IPv6Gateway": "",
                    "GlobalIPv6Address": "",
                    "GlobalIPv6PrefixLen": 0,
                    "MacAddress": "02:42:ac:11:00:03",
                    "DriverOpts": null
                }
            }
        }
    }
]
```

-   docker exec -it 进入当前正在运行的容器

```bash
#方式一
$ docker exec -it 5467d2706b3f /bin/bash
[root@5467d2706b3f /]# ls
bin  dev  etc  home  lib  lib64  lost+found  media  mnt  opt  proc  root  run  sbin  srv  sys  tmp  usr  var
 
#方式二
$ docker attach 5467d2706b3f
 
区别：
#docker exec #进入当前容器后开启一个新的终端，可以在里面操作。（常用）
#docker attach # 进入容器当前正在执行的终端
```

-   docker cp 拷贝主机与容器间资源

```bash
$ docker exec -it 5705a9861f91 /bin/bash
[root@5705a9861f91 /]# ls
bin  dev  etc  home  lib  lib64  lost+found  media  mnt  opt  proc  root  run  sbin  srv  sys  tmp  usr  var
[root@5705a9861f91 /]# touch tmp
[root@5705a9861f91 /]# echo 'abc' > tmp.java
[root@5705a9861f91 /]# ls -a
.  ..  .dockerenv  bin  dev  etc  home  lib  lib64  lost+found  media  mnt  opt  proc  root  run  sbin  srv  sys  tmp  tmp.java  usr  var
[root@5705a9861f91 /]# exit
exit
#将容器内的资源拷贝到主机
$ docker cp 5705a9861f91:tmp.java /home
 
#将主机中的资源拷贝到容器内
$ docker cp /home/tmp.java 5705a9861f91:tmp
```



<img src="res/8.jpg" alt="img" style="zoom:67%;" />

```bash
Usage:	docker [OPTIONS] COMMAND

A self-sufficient runtime for containers

Options:
      --config string      Location of client config files (default "/home/sxn/.docker")
  -c, --context string     Name of the context to use to connect to the daemon (overrides DOCKER_HOST env var and default
                           context set with "docker context use")
  -D, --debug              Enable debug mode
  -H, --host list          Daemon socket(s) to connect to
  -l, --log-level string   Set the logging level ("debug"|"info"|"warn"|"error"|"fatal") (default "info")
      --tls                Use TLS; implied by --tlsverify
      --tlscacert string   Trust certs signed only by this CA (default "/home/sxn/.docker/ca.pem")
      --tlscert string     Path to TLS certificate file (default "/home/sxn/.docker/cert.pem")
      --tlskey string      Path to TLS key file (default "/home/sxn/.docker/key.pem")
      --tlsverify          Use TLS and verify the remote
  -v, --version            Print version information and quit

Management Commands:
  builder     Manage builds
  config      Manage Docker configs
  container   Manage containers
  context     Manage contexts
  engine      Manage the docker engine
  image       Manage images
  network     Manage networks
  node        Manage Swarm nodes
  plugin      Manage plugins
  secret      Manage Docker secrets
  service     Manage services
  stack       Manage Docker stacks
  swarm       Manage Swarm
  system      Manage Docker
  trust       Manage trust on Docker images
  volume      Manage volumes

Commands:
  attach      Attach local standard input, output, and error streams to a running container
  build       Build an image from a Dockerfile
  commit      Create a new image from a container's changes
  cp          Copy files/folders between a container and the local filesystem
  create      Create a new container
  diff        Inspect changes to files or directories on a container's filesystem
  events      Get real time events from the server
  exec        Run a command in a running container
  export      Export a container's filesystem as a tar archive
  history     Show the history of an image
  images      List images
  import      Import the contents from a tarball to create a filesystem image
  info        Display system-wide information
  inspect     Return low-level information on Docker objects
  kill        Kill one or more running containers
  load        Load an image from a tar archive or STDIN
  login       Log in to a Docker registry
  logout      Log out from a Docker registry
  logs        Fetch the logs of a container
  pause       Pause all processes within one or more containers
  port        List port mappings or a specific mapping for the container
  ps          List containers
  pull        Pull an image or a repository from a registry
  push        Push an image or a repository to a registry
  rename      Rename a container
  restart     Restart one or more containers
  rm          Remove one or more containers
  rmi         Remove one or more images
  run         Run a command in a new container
  save        Save one or more images to a tar archive (streamed to STDOUT by default)
  search      Search the Docker Hub for images
  start       Start one or more stopped containers
  stats       Display a live stream of container(s) resource usage statistics
  stop        Stop one or more running containers
  tag         Create a tag TARGET_IMAGE that refers to SOURCE_IMAGE
  top         Display the running processes of a container
  unpause     Unpause all processes within one or more containers
  update      Update configuration of one or more containers
  version     Show the Docker version information
  wait        Block until one or more containers stop, then print their exit codes

Run 'docker COMMAND --help' for more information on a command.
```

